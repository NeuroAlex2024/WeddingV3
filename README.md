# Wedding

Мини-приложение для планирования свадьбы и публикации цифровых приглашений.

## Запуск проекта

1. Скопируйте `.env.example` в `.env` и обновите переменные окружения. Значения по умолчанию подходят для локальной разработки: сервер слушает `0.0.0.0:3000`, локаль интерфейса — `ru-RU`, HTTP-логи выводятся в формате `dev`, а Prisma пишет предупреждения и ошибки. Заполните `DATABASE_URL` и `JWT_SECRET` перед запуском сервера.
2. Установите зависимости:
   ```bash
   npm install
   ```
3. Поднимите PostgreSQL 15 (см. раздел ниже) и примените миграции Prisma:
   ```bash
   npm run prisma:migrate
   npm run prisma:generate
   ```
   Во время `npm run prisma:migrate` и `npm run prisma:generate` переменные `DATABASE_URL` и `JWT_SECRET` можно не указывать — конфигурация принимает неполное окружение для инструментов Prisma. Для запуска самого сервера эти переменные обязательны.
4. Запустите сервер (Express отдаёт статические файлы и API):
   ```bash
   npm run dev
   ```
   или в продуктивном режиме:
   ```bash
   npm start
   ```
5. Откройте [http://localhost:3000](http://localhost:3000) в браузере. Конструктор и опубликованные приглашения обслуживаются одним Node.js приложением.
   Если база данных временно недоступна или переменная `DATABASE_URL` не задана, сервер продолжит обслуживать статические приглашения и API конструктор (возможна деградация функциональности, зависящей от БД). В логах появится предупреждение, позволяющее контролируемо перенести инфраструктуру.

### Структура фронтенд-скриптов

- Браузерный код разбит на независимые файлы в `public/frontend/`:
  - `profile-storage.js` добавляет методы работы с `localStorage` в `window.App` через `window.ProfileStorage.attach`.
  - `router.js` экспортирует обработчики маршрутизации (`window.AppRouter.attach`).
  - `views-quiz.js`, `views-dashboard.js`, `views-website.js` регистрируют крупные функции отрисовки через `window.AppViews`.
- В `index.html` порядок подключений критичен: сначала `data.js` (глобальные константы), затем файлы из `public/frontend/`, и только после этого `app.js`, который ожидает готовые `window.ProfileStorage`, `window.AppRouter`, `window.AppViews` и монтирует их в общий объект `App`.
- При добавлении новых модулей достаточно разместить файл в `public/frontend/` и подключить его тегом `<script>` до `app.js`.

### Совместный просмотр по сети

- Убедитесь, что сервер запущен и порт 3000 открыт в файерволе.
- Узнайте локальный IP адрес хоста (например, `192.168.0.10`).
- Гости могут открывать приложение по адресу `http://192.168.0.10:3000` и переходить по сгенерированным ссылкам вида `http://192.168.0.10:3000/invite/<slug>`.

### PostgreSQL 15 локально

Самый быстрый способ запустить PostgreSQL 15 — использовать Docker:

```bash
docker run \
  --name wedding-postgres \
  -e POSTGRES_USER=wedding \
  -e POSTGRES_PASSWORD=wedding \
  -e POSTGRES_DB=wedding \
  -p 5432:5432 \
  -d postgres:15
```

После запуска контейнера установите переменную `DATABASE_URL` в `.env`, например:

```
DATABASE_URL=postgresql://wedding:wedding@localhost:5432/wedding
```

Примените миграции (они создадут таблицы `User`, `ContractorProfile`, `WeddingProfile`, `InvitationMeta` и `Guest`):

```bash
npm run prisma:migrate
```

При необходимости пересоберите Prisma Client:

```bash
npm run prisma:generate
```

### Подключение через DataGrip

- **Host**: `localhost`
- **Port**: `5432`
- **Database**: `wedding`
- **User**: `wedding`
- **Password**: `wedding`
- **Driver**: `PostgreSQL`

После ввода параметров протестируйте подключение и сохраните его для работы с схемой и данными. DataGrip увидит структуру, подготовленную миграцией `0001_init`.

## Публикация приглашений

- Кнопка «Активировать сайт» в конструкторе отправляет данные на `POST /api/invitations`.
- Сервер формирует человекочитаемый слаг на основе имён пары и даты, сохраняет статический `index.html` в директории `invites/<slug>/` и возвращает ссылку.
- Повторная публикация обновляет существующий слаг (если он передан) или создаёт новый с уникальным суффиксом.

Готовые приглашения доступны по адресу `https://wedding.ru/invite/<slug>` (локально: `http://localhost:3000/invite/<slug>`). Содержимое HTML генерируется на сервере и не зависит от `localStorage`.
