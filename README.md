# Wedding

Мини-приложение для планирования свадьбы и публикации цифровых приглашений.

## Запуск проекта

1. Скопируйте `.env.example` в `.env` и обновите переменные окружения. Значения по умолчанию подходят для локальной разработки: сервер слушает `0.0.0.0:3000`, локаль интерфейса — `ru-RU`, HTTP-логи выводятся в формате `dev`, а Prisma пишет предупреждения и ошибки. Перед запуском сервера обязательно задайте секреты авторизации и подключение к базе:

   ```env
   DATABASE_URL=postgresql://wedding:wedding@localhost:5432/wedding
   JWT_SECRET=change-me-super-secret
   JWT_ACCESS_TTL=15m
   JWT_REFRESH_TTL=30d
   ```

   TTL можно указывать числом секунд или короткими суффиксами (`s`, `m`, `h`, `d`, `w`). В среде разработки допускается не задавать переменные, установив `ALLOW_INCOMPLETE_SECRETS=1`, но для реального запуска они обязательны.
2. Установите зависимости:
   ```bash
   npm install
   ```
3. Поднимите PostgreSQL 15 (см. раздел ниже) и примените миграции Prisma:
   ```bash
   npm run prisma:migrate
   npm run prisma:generate
   ```
   Во время `npm run prisma:migrate` и `npm run prisma:generate` переменные `DATABASE_URL` и `JWT_SECRET` можно не указывать — конфигурация принимает неполное окружение для инструментов Prisma. Для запуска самого сервера эти переменные обязательны.
4. Запустите сервер (Express отдаёт статические файлы и API):
   ```bash
   npm run dev
   ```
   или в продуктивном режиме:
   ```bash
   npm start
   ```
5. Откройте [http://localhost:3000](http://localhost:3000) в браузере. Конструктор и опубликованные приглашения обслуживаются одним Node.js приложением.
   Если база данных временно недоступна или переменная `DATABASE_URL` не задана, сервер продолжит обслуживать статические приглашения и API конструктор (возможна деградация функциональности, зависящей от БД). В логах появится предупреждение, позволяющее контролируемо перенести инфраструктуру.

### Совместный просмотр по сети

- Убедитесь, что сервер запущен и порт 3000 открыт в файерволе.
- Узнайте локальный IP адрес хоста (например, `192.168.0.10`).
- Гости могут открывать приложение по адресу `http://192.168.0.10:3000` и переходить по сгенерированным ссылкам вида `http://192.168.0.10:3000/invite/<slug>`.

### PostgreSQL 15 локально

Самый быстрый способ запустить PostgreSQL 15 — использовать Docker:

```bash
docker run \
  --name wedding-postgres \
  -e POSTGRES_USER=wedding \
  -e POSTGRES_PASSWORD=wedding \
  -e POSTGRES_DB=wedding \
  -p 5432:5432 \
  -d postgres:15
```

После запуска контейнера установите переменную `DATABASE_URL` в `.env`, например:

```
DATABASE_URL=postgresql://wedding:wedding@localhost:5432/wedding
```

Примените миграции (они создадут таблицы `User`, `ContractorProfile`, `WeddingProfile`, `InvitationMeta` и `Guest`):

```bash
npm run prisma:migrate
```

При необходимости пересоберите Prisma Client:

```bash
npm run prisma:generate
```

## Проверка API авторизации

1. Зарегистрируйте пользователя по номеру телефона и одноразовому паролю, сохранив refresh-токен в cookie:

   ```bash
   curl -i -c cookies.txt \
     -H "Content-Type: application/json" \
     -X POST http://localhost:3000/api/auth/register \
     -d '{"phone":"+79991234567","password":"123456","email":"demo@example.com"}'
   ```

2. Выполните вход с тем же номером и паролем. Ответ вернёт `accessToken`, а cookie `refreshToken` обновится в файле `cookies.txt`:

   ```bash
   curl -i -b cookies.txt -c cookies.txt \
     -H "Content-Type: application/json" \
     -X POST http://localhost:3000/api/auth/login \
     -d '{"phone":"+79991234567","password":"123456"}'
   ```

3. Скопируйте `accessToken` из ответа и запросите защищённый профиль (refresh-токен при этом автоматически отправится из cookie):

   ```bash
   curl -H "Authorization: Bearer <ACCESS_TOKEN>" \
     http://localhost:3000/api/profile
   ```

Если фронтенд ещё не переключён на новую схему авторизации, браузер продолжит работать по прежнему локальному сценарию (данные профиля и состояния хранятся в `localStorage`). Новое API доступно параллельно и будет использоваться в дальнейшем, когда клиентскую часть адаптируют.

## Смоук-тест кабинета

1. Запустите сервер (`npm run dev`) и зарегистрируйте пользователя роли `wedding` через `/api/auth/register` или форму входа.
2. Авторизуйтесь под этим аккаунтом и откройте дашборд. Отметьте этап таймлайна, добавьте задачу в чек-лист и новую строку бюджета. Обновите страницу — данные должны остаться на месте.
3. Выйдите из аккаунта, зарегистрируйте пользователя роли `contractor` и повторите шаги с таймлайном, чек-листом и бюджетом. После обновления страницы убедитесь, что коллекции подгружаются с сервера.
4. Остановите и заново запустите сервер (`Ctrl+C`, затем `npm run dev`). Перелогиньтесь под обеими ролями и убедитесь, что внесённые изменения восстановились из базы данных.

### Подключение через DataGrip

- **Host**: `localhost`
- **Port**: `5432`
- **Database**: `wedding`
- **User**: `wedding`
- **Password**: `wedding`
- **Driver**: `PostgreSQL`

После ввода параметров протестируйте подключение и сохраните его для работы с схемой и данными. DataGrip увидит структуру, подготовленную миграцией `0001_init`.

## Публикация приглашений

- Кнопка «Активировать сайт» в конструкторе отправляет данные на `POST /api/invitations`.
- Сервер формирует человекочитаемый слаг на основе имён пары и даты, сохраняет статический `index.html` в директории `invites/<slug>/` и возвращает ссылку.
- Повторная публикация обновляет существующий слаг (если он передан) или создаёт новый с уникальным суффиксом.

Готовые приглашения доступны по адресу `https://wedding.ru/invite/<slug>` (локально: `http://localhost:3000/invite/<slug>`). Содержимое HTML генерируется на сервере и не зависит от `localStorage`.
